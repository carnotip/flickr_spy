<!DOCTYPE html>
<html>
  <head>
    <title>Flickr Spy</title>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.0r4/build/reset-fonts-grids/reset-fonts-grids.css">
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.8.0r4/build/base/base-min.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/flick/jquery-ui.css" type="text/css" media="all" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
    
    <script type="text/javascript" src="/jquery.nano.js"></script>
    <script type="text/javascript" src="/jquery.sqrop.js"></script>
    
    <script type="text/javascript" src="/ws/swfobject.js"></script>
    <script type="text/javascript" src="/ws/FABridge.js"></script>
    <script type="text/javascript" src="/ws/web_socket.js"></script>
    <script type="text/javascript">
      WebSocket.__swfLocation = "/ws/WebSocketMain.swf";
    </script>
       
    <script type="text/javascript">
      /*
      $(function(){
        $("canvas").attr("width", $("body").width()).attr("height", 100);
        var canvas = $("canvas").get(0)
        var context = canvas.getContext("2d");
        var imgd = context.createImageData(100, 100);

        function putPixel (i, x, y, r, g, b, a) {
          var p = (x * i.width + y) * 4;
          i.data[p    ] = r;
          i.data[p + 1] = g;
          i.data[p + 2] = b;
          i.data[p + 3] = a;
        }
        
        function getPixel(i, x, y) {
          var p = (x * i.width + y) * 4;
          var pixel = Array.prototype.slice.call(i.data, p, p + 4);
          console.log(pixel)
        }
        
        putPixel(imgd, 10, 10, 255, 0, 0, 255);
        getPixel(imgd, 10, 10);
        context.putImageData(imgd, 0, 0);
      })
      */
      (function() {
        var spy = {
          append: function (data) {
            $($.nano('<a href="{page}"><img class="crop" src="{image}" /></a>', data)).
              appendTo($("#results")).find("img").hide().load(function(){$(this).sqrop(240).show()})
          },
          debug: function (data) {
            data.title = data.title || "Untitled";
            $($.nano('<a href="{page}">{title}</a><br />', data)).appendTo($("#results"))
            $("#info h1").html(data.requests_count)
          },
          go: function (options, callback) {
            var self = this;
            var ws = new WebSocket("ws://" + window.location.hostname + ":8080/" + options.nickname);
            
            ws.onmessage = function(e) {
              self[options.debug ? "debug": "append"](JSON.parse(e.data))
            };
            ws.onclose = function(e) {
              if(callback) {
                callback();
              }
            };
          },
          boot: function () {
            var self = this;
            $(function(){
              var b = $("#button"),
                n = $("#nickname"),
                d = $("#debug"),
                s = $("#search");

              b.click(function(){
                if(n.val().length > 0) {
                  s.find("input").attr("disabled", "disabled").addClass("ui-state-disabled");
                  $("#results").empty()
                  self.go({ nickname: n.val(), debug: d.is(":checked") }, function(){
                    s.find("input").removeAttr("disabled").removeClass("ui-state-disabled");
                  });
                } else {
                  n.focus()
                }
                return false;
              });
            });
          }
        }
        spy.boot();
      })();
    </script>
    <style>
      img {border: none;}
      a{margin: 0; padding: 0;}
    </style>
  </head>
  <body>
    <div id="doc" class="yui-t7">
      <div id="hd" role="search">
        <h1>Flickr Spy</h1>
        <form id="search">
          <label for="nickname">Nickname</label>
          <input type="text" name="nickname" id="nickname" />
          <label for="debug">Debug</label>
          <input type="checkbox" name="debug" id="debug" />
          <input type="submit" class="ui-state-default" id="button" value="Go!" />
        </form>
        <div id="info">
          <h1></h1>
        </div>
      </div>
      <div id="bd" role="main">
        <div class="yui-g">
          <div id="results">
          </div>
        </div>
      </div>
    </div>  
  </body>
</html>
